<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Check users on this line</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin:16px; background:#f7fafc; color:#111827; }
    .page-title { margin:0 0 12px 0; font-size:20px; }
    .card { background:white; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); max-width:760px; margin-bottom:12px; }
    .row { margin:8px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#6b7280; }
    .hidden { display:none; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn.primary { background:#0ea5a4; color:white; }
    .btn.success { background:#10b981; color:white; }
    .btn.danger { background:#ef4444; color:white; }
    select, input[type="text"], input[type="number"], textarea { padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px; }
    textarea { min-height:80px; width:100%; }
    input[type="file"] { display:block; padding:8px; border-radius:8px; border:2px dashed #aaa; background:#f9f9f9; cursor:pointer; width:100%; }
    .small-text { font-size:12px; }
    .center { justify-content:center; }
    .actions { display:flex; gap:8px; align-items:center; }
    .spinner-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); z-index:9999; }
    .spinner { width:48px; height:48px; border-radius:50%; border:5px solid #f3f4f6; border-top-color:#3b82f6; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }
    .toast { position:fixed; right:12px; bottom:12px; background:#111827; color:white; padding:8px 12px; border-radius:8px; z-index:10001; opacity:0.95; }
    .toast.success { background:#059669; }
    .toast.error { background:#dc2626; }
    .toast.info { background:#0ea5a4; }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2000; align-items:center; justify-content:center; }
    .modal-box { background:white; padding:16px; border-radius:10px; max-width:900px; width:95%; max-height:85vh; overflow:auto; box-shadow:0 8px 30px rgba(0,0,0,0.2); }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { padding:8px; border:1px solid #e5e7eb; text-align:left; font-size:13px; }
    th { background:#f3f4f6; }
    .selected { border-color:#45b08e; background:#e6ffed; }
    .timestamp-display { font-size:13px; color:#374151; margin-left:6px; }
  </style>
</head>
<body>
  <header>
    <h2 class="page-title">Check users on this line</h2>
  </header>

  <div id="signinCard" class="card">
    <div class="row center">
      <div id="signinBtn"></div>
    </div>
    <div id="accessMsg" class="row muted small-text">
      Please contact Admin if your ID is not registered!
    </div>
    <div id="deniedMsg" class="row" style="color:#b91c1c; display:none;">
      Access denied — Contact admin for allowing your mail ID!
    </div>
  </div>

  <div id="formCard" class="card hidden">
    <div class="row muted" id="whoami"></div>

    <form id="dataForm" class="form">
      <input type="email" name="email" class="hidden" readonly required />
      <input type="hidden" name="startTime" />

      <div class="row">
        <select name="windowoption" required>
          <option value="">Select Window</option>
          <option>Merotra</option>
          <option>Sunny</option>
        </select>
      </div>

      <div class="row">
        <button type="button" id="tsBtn1" class="btn primary">पहली बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts1disp" class="timestamp-display"></span>
      </div>
      <div class="row">
        <button type="button" id="tsBtn2" class="btn primary">दूसरी बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts2disp" class="timestamp-display"></span>
      </div>
      <div class="row">
        <button type="button" id="tsBtn3" class="btn primary">तीसरी बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts3disp" class="timestamp-display"></span>
      </div>

      <div class="row">
        <select name="splitter" required>
          <option value="">Select Splitter</option>
          <option>2 way</option>
          <option>4 way</option>
          <option>8 way</option>
          <option>Link JC</option>
        </select>
      </div>

      <div class="form-step">ड्रम नंबर और जे सी की फोटो</div>
      <div class="row">
        <input type="file" name="photo1" accept="image/*" capture="environment" required />
      </div>

      <div class="form-step">पोल और लोकेशन की फोटो थोड़ी दूर से</div>
      <div class="row">
        <input type="file" name="photo2" accept="image/*" capture="environment" required />
      </div>

      <div class="row">
        <input type="text" name="jcname" required placeholder="Enter JC Name" />
      </div>

      <div class="row">
        <select name="wire" required>
          <option value="">Select Wire</option>
          <option>1 Core</option>
          <option>2 Core</option>
          <option>4 Core</option>
          <option>6 Core</option>
          <option>12 Core</option>
          <option>96 Core</option>
        </select>
      </div>

      <div class="row">
        <input type="number" name="vacantcores" required placeholder="Enter Vacant Cores" />
      </div>

      <div class="row">
        <select name="wirecolor">
          <option value="">Select fiber color</option>
          <option>Black</option>
          <option>Orange</option>
          <option>Other</option>
        </select>
      </div>

      <div class="row">
        <input type="text" name="linename" placeholder="Line Name (Optional)" />
      </div>

      <div class="row">
        <input type="text" name="drumno" placeholder="Drum No (Optional)" />
      </div>

      <div class="row">
        <input type="text" name="remark" placeholder="Input power (मापें/नोट्स)" />
      </div>

      <div class="row actions">
        <button type="button" id="submitBtn" class="btn success" disabled>Submit to check users on this line</button>
        <span id="submitStatus" class="muted small-text"></span>
      </div>
    </form>
  </div>

  <div id="userListModal" class="modal-overlay">
    <div class="modal-box">
      <h3>User list on this line</h3>
      <div id="userListContainer">
        <div class="muted small-text">Loading...</div>
      </div>
      <div class="modal-actions">
        <button id="closeUserListBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
  const allowedEmails = ["shahzebahmad2024@gmail.com","trustindeal.amanwiz@gmail.com","alamshan761@gmail.com","ganeshnigam597@gmail.com","sushilyadav8352@gmail.com","ainulkhan424@gmail.com","sushilya9044@gmail.com","sy7903125@gmail.com"];
  const scriptURL = "https://script.google.com/macros/s/AKfycbyBZtPsTNzsQo5OMNE6yqGmWb12030EzpmxzOXPzNlKrvEOIunkYL-8B6pjWfYtuq9R/exec";
  const clientID = "599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com";

  // ======= CHANGE THIS VALUE EASILY =======
  // Disable seconds for submit button after submit (8 minutes). Change here if needed.
  const DISABLE_SECONDS = 3 * 60; // <<-- change this number (in seconds) to adjust disable period
  // =======================================

  const TIMER_UPDATE_INTERVAL = 3000; // display update every 3 seconds
  let timerInterval = null;
  let timerRemaining = 0;
  let timerDisplayInterval = null;

  const fieldsToSave = ['windowoption','splitter','jcname','wire','vacantcores','wirecolor','linename','drumno','remark'];

  window.onload = () => {
    if (window.google && google.accounts && google.accounts.id) {
      google.accounts.id.initialize({ client_id: clientID, callback: handleCredentialResponse });
      google.accounts.id.renderButton(document.getElementById("signinBtn"), { theme: "outline", size: "large", type: "standard", shape: "pill" });
    }
    document.getElementById("submitBtn").addEventListener("click", onSubmitClick);
    document.getElementById("closeUserListBtn").addEventListener("click", closeUserListModal);
    document.getElementById('tsBtn1').addEventListener('click', ()=>captureTimestamp(1));
    document.getElementById('tsBtn2').addEventListener('click', ()=>captureTimestamp(2));
    document.getElementById('tsBtn3').addEventListener('click', ()=>captureTimestamp(3));
    document.getElementById('dataForm').addEventListener('change', saveFormData);
    document.querySelector('[name="photo1"]').addEventListener('change', savePhotoAndHighlight);
    document.querySelector('[name="photo2"]').addEventListener('change', savePhotoAndHighlight);
    const savedSession = JSON.parse(localStorage.getItem("userSession")||null);
    const ONE_HOUR = 60*60*1000;
    if (savedSession && (Date.now()-savedSession.timestamp < ONE_HOUR)) {
      document.querySelector("input[name='email']").value = savedSession.email;
      document.getElementById("signinCard").classList.add("hidden");
      document.getElementById("formCard").classList.remove("hidden");
      initializeForm();
    }
  };

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(jsonPayload);
    } catch { return {}; }
  }

  function handleCredentialResponse(response) {
    const payload = parseJwt(response.credential);
    const email = payload.email || "";
    if (allowedEmails.includes(email)) {
      localStorage.setItem("userSession", JSON.stringify({ email: email, timestamp: Date.now() }));
      document.querySelector('[name="email"]').value = email;
      document.getElementById("deniedMsg").classList.add("hidden");
      document.getElementById("signinCard").classList.add("hidden");
      document.getElementById("formCard").classList.remove("hidden");
      initializeForm();
    } else {
      document.getElementById("deniedMsg").style.display = "block";
    }
  }

  function autoDetectLocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      let loc = document.querySelector("[name=locationLink]");
      if (!loc) {
        loc = document.createElement('input'); loc.type='hidden'; loc.name='locationLink';
        document.getElementById('dataForm').appendChild(loc);
      }
      loc.value = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    }, ()=>{}, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  }

  function compressImageToDataURL(file, maxKB = 200) {
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onerror = ()=>reject(new Error("Failed to read file"));
      reader.onload = ()=>{
        const img = new Image();
        img.onerror = ()=>reject(new Error("Invalid image"));
        img.onload = ()=>{
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const scale = Math.min(1, Math.sqrt((maxKB*1024)/(file.size || (img.width*img.height))));
          canvas.width = Math.max(1, Math.round(img.width*scale));
          canvas.height = Math.max(1, Math.round(img.height*scale));
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          let quality = 0.75;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          while (dataUrl.length/1024 > maxKB && quality > 0.2) { quality -= 0.05; dataUrl = canvas.toDataURL("image/jpeg", quality); }
          resolve(dataUrl);
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  async function onSubmitClick() {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn.dataset.mode === 'show') { openUserListModal(); return; }
    // Validate timestamps captured locally before submit
    const t1 = localStorage.getItem('ts1'), t2 = localStorage.getItem('ts2'), t3 = localStorage.getItem('ts3');
    if (!t1 || !t2 || !t3) { showToast("कृपया तीनों टाइमस्टैम्प पहले कैप्चर करें।", "error"); return; }
    const form = document.getElementById('dataForm');
    const p1 = form.photo1.files[0], p2 = form.photo2.files[0];
    if (!p1 || !p2) { showToast("❌ Both JC Photo and Area Photo are required", "error"); return; }

    const overlay = document.createElement("div"); overlay.className="spinner-overlay"; overlay.innerHTML = '<div class="spinner"></div>';
    document.body.appendChild(overlay);

    let photos;
    try { photos = [await compressImageToDataURL(p1,200), await compressImageToDataURL(p2,200)]; }
    catch(err){ document.querySelector(".spinner-overlay")?.remove(); showToast("❌ Image processing failed: "+err.message, "error"); return; }

    const payload = {
      action: "submit",
      email: form.email.value,
      locationLink: form.locationLink ? form.locationLink.value : "",
      photos,
      jcname: form.jcname.value,
      splitter: form.splitter.value,
      wire: form.wire.value,
      wirecolor: form.wirecolor.value,
      linename: form.linename.value,
      drumno: form.drumno.value,
      remark: form.remark.value,
      vacantcores: form.vacantcores.value,
      windowoption: form.windowoption.value,
      ts1: localStorage.getItem('ts1') || "",
      ts2: localStorage.getItem('ts2') || "",
      ts3: localStorage.getItem('ts3') || ""
    };

    try {
      const r = await fetch(scriptURL, { method: "POST", headers: { "Content-Type":"text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
      const resp = await r.json();
      document.querySelector(".spinner-overlay")?.remove();
      if (resp.status === "success") {
        showToast("✅ Data submitted. You can view user list after the wait period.", "success");
        // disable submit button for configured seconds. This value is placed above as DISABLE_SECONDS for easy edit.
        startDisableTimer(DISABLE_SECONDS);
        // clear local timestamps so popup will rely on sheet timestamps
        localStorage.removeItem('ts1'); localStorage.removeItem('ts2'); localStorage.removeItem('ts3');
        document.getElementById('ts1disp').textContent=''; document.getElementById('ts2disp').textContent=''; document.getElementById('ts3disp').textContent='';
      } else showToast("❌ "+(resp.message||"Server error"), "error");
    } catch(err) {
      document.querySelector(".spinner-overlay")?.remove();
      showToast("❌ Network error: "+err, "error");
    }
  }

  function startDisableTimer(seconds) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.dataset.mode = 'submit';
    timerRemaining = seconds;
    clearInterval(timerInterval); clearInterval(timerDisplayInterval);
    timerInterval = setInterval(()=> {
      timerRemaining = Math.max(0, timerRemaining-1);
      if (timerRemaining === 0) {
        clearInterval(timerInterval);
        submitBtn.disabled = false;
        submitBtn.dataset.mode = 'show';
        submitBtn.textContent = 'Show user list';
        showToast("✅ You can now view the user list.", "success");
      }
    }, 1000);
    timerDisplayInterval = setInterval(updateSubmitTimerDisplay, TIMER_UPDATE_INTERVAL);
    updateSubmitTimerDisplay();
  }

  function updateSubmitTimerDisplay() {
    const submitBtn = document.getElementById('submitBtn');
    if (timerRemaining > 0) {
      const mm = Math.floor(timerRemaining/60), ss = timerRemaining%60;
      submitBtn.textContent = `Submit to check users on this line (${mm}m ${ss}s)`;
    }
  }

  function captureTimestamp(which) {
    const now = new Date();
    const iso = now.toISOString();
    localStorage.setItem('ts'+which, iso);
    document.getElementById('ts'+which+'disp').textContent = iso.replace('T',' ').split('.')[0];
    showToast(`Timestamp ${which} captured`, "info");
    const t1 = localStorage.getItem('ts1'), t2 = localStorage.getItem('ts2'), t3 = localStorage.getItem('ts3');
    if (t1 && t2 && t3) document.getElementById('submitBtn').disabled = false;
  }

  function showToast(text, type="default") {
    const toast = document.createElement("div"); toast.className=`toast ${type}`; toast.textContent = text;
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),600); },3000);
  }

  function saveFormData() {
    const data = {};
    fieldsToSave.forEach(field => { const el = document.querySelector(`[name="${field}"]`); if (el) data[field] = el.value; });
    localStorage.setItem('formData', JSON.stringify(data));
  }

  async function loadFormData() {
    const data = JSON.parse(localStorage.getItem('formData')||"{}");
    fieldsToSave.forEach(field => { const el = document.querySelector(`[name="${field}"]`); if (el && data[field]) el.value = data[field]; });
    await loadPhoto('photo1'); await loadPhoto('photo2');
    const t1 = localStorage.getItem('ts1'); if (t1) document.getElementById('ts1disp').textContent = t1.replace('T',' ').split('.')[0];
    const t2 = localStorage.getItem('ts2'); if (t2) document.getElementById('ts2disp').textContent = t2.replace('T',' ').split('.')[0];
    const t3 = localStorage.getItem('ts3'); if (t3) document.getElementById('ts3disp').textContent = t3.replace('T',' ').split('.')[0];
    if (t1 && t2 && t3) document.getElementById('submitBtn').disabled = false;
  }

  async function loadPhoto(name) {
    const base64 = localStorage.getItem(name);
    if (!base64) return;
    try {
      const response = await fetch(base64); const blob = await response.blob();
      const file = new File([blob], `${name}.jpg`, {type:'image/jpeg'}); const input = document.querySelector(`[name="${name}"]`);
      const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; input.classList.add('selected');
    } catch(err){ console.error('Failed to load photo:',err); }
  }

  function savePhotoAndHighlight(e) {
    const input = e.target; const file = input.files[0];
    if (file) { compressImageToDataURL(file,200).then(dataUrl=>{ localStorage.setItem(input.name, dataUrl); input.classList.add('selected'); }).catch(err=>console.error(err)); }
    else input.classList.remove('selected');
  }

  function initializeForm() {
    document.getElementById("whoami").innerHTML = `Check users on this line`;
    loadFormData();
    fieldsToSave.forEach(field => { const elem = document.querySelector(`[name="${field}"]`); if (elem){ elem.addEventListener('change', saveFormData); elem.addEventListener('input', saveFormData); }});
    autoDetectLocation();
  }

  // User list modal and fetch (server will read timestamps from sheet)
  function openUserListModal() {
    document.getElementById('userListContainer').innerHTML = '<div class="muted small-text">Fetching user list…</div>';
    document.getElementById('userListModal').style.display = 'flex';
    fetchUserList();
  }
  function closeUserListModal() { document.getElementById('userListModal').style.display = 'none'; }

  async function fetchUserList() {
    const email = document.querySelector('[name="email"]').value;
    const windowoption = document.querySelector('[name="windowoption"]').value;
    if (!windowoption) { document.getElementById('userListContainer').innerHTML = '<div class="muted small-text">Please select window first.</div>'; return; }
    const payload = { action:'get_users', windowoption, email };
    try {
      const r = await fetch(scriptURL, { method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"}, body: JSON.stringify(payload) });
      const resp = await r.json();
      if (resp.status === 'success' && Array.isArray(resp.users)) renderUserTable(resp.users);
      else document.getElementById('userListContainer').innerHTML = `<div class="muted small-text">${resp.message || 'No users found'}</div>`;
    } catch(err) {
      document.getElementById('userListContainer').innerHTML = `<div class="muted small-text">Network error: ${err}</div>`;
    }
  }

  function renderUserTable(users) {
    if (!users.length) { document.getElementById('userListContainer').innerHTML = '<div class="muted small-text">No common users found near the saved timestamps.</div>'; return; }
    let html = '<table><thead><tr><th>SN</th><th>User name</th><th>Contact</th><th>Area</th><th>Time</th></tr></thead><tbody>';
    users.forEach((u,idx)=>{ html += `<tr><td>${idx+1}</td><td>${escapeHtml(u.username||'')}</td><td>${escapeHtml(u.contact||'')}</td><td>${escapeHtml(u.area||'')}</td><td>${escapeHtml(u.time||'')}</td></tr>`; });
    html += '</tbody></table>'; document.getElementById('userListContainer').innerHTML = html;
  }

  function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
</script>
</body>
</html>
