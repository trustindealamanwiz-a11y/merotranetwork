<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Check users on this line</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {font-family: Arial, Helvetica, sans-serif; margin:16px; background:#f7fafc; color:#111827;}
    .page-title {font-size:20px; margin:0 0 12px 0;}
    .card {background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); max-width:900px; margin-bottom:12px;}
    .row {margin:8px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .muted {color:#6b7280;}
    .hidden {display:none;}
    .btn {padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600;}
    .btn.primary {background:#0ea5a4; color:#fff;}
    .btn.success {background:#10b981; color:#fff;}
    .btn.danger {background:#ef4444; color:#fff;}
    .btn.disabled {background:#9ca3af !important; cursor:not-allowed; opacity:0.7;}
    select,input[type="text"],input[type="number"],textarea {padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px;}
    textarea {min-height:80px; width:100%;}
    input[type="file"] {display:block; padding:8px; border-radius:8px; border:2px dashed #aaa; background:#f9f9f9; cursor:pointer; width:100%;}
    .small-text {font-size:12px;}
    .center {justify-content:center;}
    .actions {display:flex; gap:8px; align-items:center;}
    .timer-text {font-weight:600; color:#dc2626; min-width:80px;}
    .spinner-overlay {position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:9999;}
    .spinner {width:48px; height:48px; border-radius:50%; border:5px solid #f3f4f6; border-top-color:#3b82f6; animation:spin 1s linear infinite;}
    @keyframes spin {to{transform:rotate(360deg);}}
    .toast {position:fixed; right:12px; bottom:12px; background:#111827; color:#fff; padding:8px 12px; border-radius:8px; z-index:10001; opacity:0.95;}
    .toast.success{background:#059669;}.toast.error{background:#dc2626;}.toast.info{background:#0ea5a4;}
    .modal-overlay {display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2000; align-items:center; justify-content:center;}
    .modal-box {background:#fff; padding:16px; border-radius:10px; max-width:980px; width:95%; max-height:85vh; overflow:auto; box-shadow:0 8px 30px rgba(0,0,0,0.2);}
    table {width:100%; border-collapse:collapse; margin-top:8px;}
    th,td {padding:8px; border:1px solid #e5e7eb; text-align:left; font-size:13px;}
    th {background:#f3f4f6;}
    .selected {border-color:#45b08e; background:#e6ffed;}
    .timestamp-display {font-size:13px; color:#374151; margin-left:6px; min-width:260px; display:inline-block;}
    @keyframes blink {50%{opacity:0;}}
    .blink {animation:blink 1s infinite;}
    #statusDot {font-size:18px; margin-right:8px; vertical-align:middle;}
    #userListStatus {display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:700;}
  </style>
</head>
<body>
  <header><h2 class="page-title">Check users on this line</h2></header>

  <div id="signinCard" class="card">
    <div class="row center"><div id="signinBtn"></div></div>
    <div id="accessMsg" class="row muted small-text">Please contact Admin if your ID is not registered!</div>
    <div id="deniedMsg" class="row" style="color:#b91c1c; display:none;">Access denied — Contact admin for allowing your mail ID!</div>
  </div>

  <div id="formCard" class="card hidden">
    <div class="row muted" id="whoami"></div>
    <form id="dataForm" class="form">
      <input type="email" name="email" class="hidden" readonly required />
      <input type="hidden" name="startTime" />
      <div class="row">
        <select name="windowoption" required>
          <option value="">Select Window</option>
          <option value="Merotra">Merotra</option>
          <option value="Sunny">Sunny</option>
        </select>
      </div>

      <div class="row">
        <button type="button" id="tsBtn1" class="btn primary">पहली बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts1disp" class="timestamp-display"></span>
        <span id="timer1" class="timer-text hidden"></span>
      </div>
      <div class="row">
        <button type="button" id="tsBtn2" class="btn primary disabled" disabled>दूसरी बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts2disp" class="timestamp-display"></span>
        <span id="timer2" class="timer-text hidden"></span>
      </div>
      <div class="row">
        <button type="button" id="tsBtn3" class="btn primary disabled" disabled>तीसरी बार जोड़ते ही तुरंत क्लिक करें</button>
        <span id="ts3disp" class="timestamp-display"></span>
      </div>

      <div class="row">
        <select name="splitter" required>
          <option value="">Select Splitter</option>
          <option>2 way</option><option>4 way</option><option>8 way</option><option>Link JC</option>
        </select>
      </div>

      <div class="form-step">ड्रम नंबर और जे सी की फोटो</div>
      <div class="row"><input type="file" name="photo1" accept="image/*" capture="environment" required /></div>
      <div class="form-step">पोल और लोकेशन की फोटो थोड़ी दूर से</div>
      <div class="row"><input type="file" name="photo2" accept="image/*" capture="environment" required /></div>

      <div class="row"><input type="text" name="jcname" required placeholder="Enter JC Name" /></div>
      <div class="row">
        <select name="wire" required>
          <option value="">Select Wire</option><option>1 Core</option><option>2 Core</option><option>4 Core</option><option>6 Core</option><option>12 Core</option><option>96 Core</option>
        </select>
      </div>
      <div class="row"><input type="number" name="vacantcores" required placeholder="Enter Vacant Cores" /></div>
      <div class="row">
        <select name="wirecolor">
          <option value="">Select fiber color</option><option>Black</option><option>Orange</option><option>Other</option>
        </select>
      </div>
      <div class="row"><input type="text" name="linename" placeholder="Line Name (Optional)" /></div>
      <div class="row"><input type="text" name="drumno" placeholder="Drum No (Optional)" /></div>
      <div class="row"><input type="text" name="remark" placeholder="Input power (मापें/नोट्स)" /></div>

      <div class="row actions">
        <button type="button" id="submitBtn" class="btn success" disabled>Submit to check users on this line</button>
        <span id="submitStatus" class="muted small-text"></span>
      </div>
    </form>
  </div>

  <div id="userListModal" class="modal-overlay">
    <div class="modal-box">
      <div id="userListStatus">
        <span id="statusDot">O</span>
        <span id="statusText">Fetching user list…</span>
      </div>
      <div id="userListContainer"><div class="muted small-text">Waiting…</div></div>
      <div class="modal-actions" style="margin-top:12px; justify-content:flex-end;">
        <button id="closeUserListBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const allowedEmails = ["shahzebahmad2024@gmail.com","trustindeal.amanwiz@gmail.com","alamshan761@gmail.com","ganeshnigam597@gmail.com","mehrotracablenetwork@gmail.com","sushilyadav8352@gmail.com","ainulkhan424@gmail.com","sushilya9044@gmail.com","sy7903125@gmail.com"];
const clientID = "599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com";
const DISABLE_SECONDS = 6 * 60;
const TIMER_UPDATE_INTERVAL = 3000;
let timerInterval = null, timerDisplayInterval = null, timerRemaining = 0;
let countdownInterval = null;
const fieldsToSave = ['windowoption','splitter','jcname','wire','vacantcores','wirecolor','linename','drumno','remark'];

// Google Sheet File IDs
const SHEET_IDS = {
  Sunny: "1oYRi3wji65zODvUD-P3yL5vtyPUBq35xLws0ihg0O1Y",
  Merotra: "1oN4d2HCKLcTgogItpVgWUmDTxY28RDhtrVKEMt0PmzA"
};

/* ========== INIT ========== */
window.onload = () => {
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({ client_id: clientID, callback: handleCredentialResponse });
    google.accounts.id.renderButton(document.getElementById("signinBtn"), { theme: "outline", size: "large", type: "standard", shape: "pill" });
  }
  document.getElementById("submitBtn").addEventListener("click", onSubmitClick);
  document.getElementById("closeUserListBtn").addEventListener("click", closeUserListModal);
  document.getElementById('dataForm').addEventListener('change', saveFormData);
  document.querySelector('[name="photo1"]').addEventListener('change', savePhotoAndHighlight);
  document.querySelector('[name="photo2"]').addEventListener('change', savePhotoAndHighlight);

  const savedSession = JSON.parse(localStorage.getItem("userSession")||null);
  const ONE_HOUR = 60*60*1000;
  if (savedSession && (Date.now() - savedSession.timestamp < ONE_HOUR)) {
    document.querySelector("input[name='email']").value = savedSession.email;
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
    initializeForm();
  }
};

/* ========== GOOGLE SIGN IN HELPERS ========== */
function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  } catch { return {}; }
}
function handleCredentialResponse(response) {
  const payload = parseJwt(response.credential);
  const email = payload.email || "";
  if (allowedEmails.includes(email)) {
    localStorage.setItem("userSession", JSON.stringify({ email, timestamp: Date.now() }));
    document.querySelector('[name="email"]').value = email;
    document.getElementById("deniedMsg").classList.add("hidden");
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
    initializeForm();
  } else {
    document.getElementById("deniedMsg").style.display = "block";
  }
}

/* ========== IMAGE COMPRESSION ========== */
function compressImageToDataURL(file, maxKB = 200) {
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onerror = ()=>reject(new Error("Failed to read file"));
    reader.onload = ()=>{
      const img = new Image();
      img.onerror = ()=>reject(new Error("Invalid image"));
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const scale = Math.min(1, Math.sqrt((maxKB*1024)/(file.size || (img.width*img.height))));
        canvas.width = Math.max(1, Math.round(img.width*scale));
        canvas.height = Math.max(1, Math.round(img.height*scale));
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        let quality = 0.75;
        let dataUrl = canvas.toDataURL("image/jpeg", quality);
        while (dataUrl.length/1024 > maxKB && quality > 0.2) { quality -= 0.05; dataUrl = canvas.toDataURL("image/jpeg", quality); }
        resolve(dataUrl);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ========== SUBMIT FLOW ========== */
async function onSubmitClick() {
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn.dataset.mode === 'show') { openUserListModal(); return; }

  const t1 = localStorage.getItem('ts1'), t2 = localStorage.getItem('ts2'), t3 = localStorage.getItem('ts3');
  if (!t1 || !t2 || !t3) { showToast("कृपया तीनों टाइमस्टैम्प पहले कैप्चर करें।", "error"); return; }

  showToast("टाइमस्टैम्प सफलतापूर्वक कैप्चर हुए। अब यूजर लिस्ट देखें।", "success");
  startDisableTimer(DISABLE_SECONDS);
  localStorage.removeItem('ts1'); localStorage.removeItem('ts2'); localStorage.removeItem('ts3');
  document.getElementById('ts1disp').textContent=''; document.getElementById('ts2disp').textContent=''; document.getElementById('ts3disp').textContent='';
  resetTimestampButtons();
}

/* ===== Submit disable timer ===== */
function startDisableTimer(seconds) {
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.dataset.mode = 'submit';
  timerRemaining = seconds;
  clearInterval(timerInterval); clearInterval(timerDisplayInterval);
  timerInterval = setInterval(()=> {
    timerRemaining = Math.max(0, timerRemaining - 1);
    if (timerRemaining === 0) {
      clearInterval(timerInterval);
      submitBtn.disabled = false;
      submitBtn.dataset.mode = 'show';
      submitBtn.textContent = 'Show user list';
      showToast("You can now view the user list.", "success");
    }
  }, 1000);
  timerDisplayInterval = setInterval(updateSubmitTimerDisplay, TIMER_UPDATE_INTERVAL);
  updateSubmitTimerDisplay();
}
function updateSubmitTimerDisplay() {
  const submitBtn = document.getElementById('submitBtn');
  if (timerRemaining > 0) {
    const mm = Math.floor(timerRemaining/60), ss = timerRemaining%60;
    submitBtn.textContent = `Submit to check users on this line (${mm}m ${ss}s)`;
  }
}

/* ========== TIMESTAMP SEQUENCE + 10‑SEC COUNTDOWN ========== */
let countdownSeconds = 0;
function startCountdown(displayId, nextBtnId) {
  countdownSeconds = 10;
  const el = document.getElementById(displayId);
  el.classList.remove('hidden');
  el.textContent = `${countdownSeconds}s`;
  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    countdownSeconds--;
    if (countdownSeconds <= 0) {
      clearInterval(countdownInterval);
      el.classList.add('hidden');
      const nextBtn = document.getElementById(nextBtnId);
      nextBtn.classList.remove('disabled');
      nextBtn.disabled = false;
    } else {
      el.textContent = `${countdownSeconds}s`;
    }
  }, 1000);
}

function captureTimestamp(which) {
  const btn = document.getElementById(`tsBtn${which}`);
  if (btn.classList.contains('disabled') || btn.disabled) return;

  const now = new Date();
  const iso = now.toISOString();
  const localDisplay = now.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }).replace(',', '');

  localStorage.setItem(`ts${which}`, iso);
  document.getElementById(`ts${which}disp`).textContent = localDisplay;
  showToast(`Timestamp ${which} captured`, "info");

  btn.classList.add('disabled');
  btn.disabled = true;

  if (which === 1) {
    startCountdown('timer1', 'tsBtn2');
  } else if (which === 2) {
    startCountdown('timer2', 'tsBtn3');
  } else if (which === 3) {
    document.getElementById('submitBtn').disabled = false;
  }
}

function resetTimestampButtons() {
  clearInterval(countdownInterval);
  ['timer1','timer2'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  ['1','2','3'].forEach(n => {
    const btn = document.getElementById(`tsBtn${n}`);
    if (n === '1') {
      btn.classList.remove('disabled');
      btn.disabled = false;
    } else {
      btn.classList.add('disabled');
      btn.disabled = true;
    }
  });
  document.getElementById('submitBtn').disabled = true;
}

/* ========== FETCH USER LIST FROM GOOGLE SHEETS - FIXED ========== */
async function fetchUserList() {
  const dot = document.getElementById('statusDot'), text = document.getElementById('statusText');
  dot.textContent = "O"; dot.classList.add("blink"); text.textContent = "Fetching user list…";

  const windowoption = document.querySelector('[name="windowoption"]').value;
  const email = document.querySelector('[name="email"]').value;

  if (!windowoption) {
    dot.classList.remove("blink"); dot.textContent = "R"; text.textContent = "Select window";
    document.getElementById('userListContainer').innerHTML = '<div class="muted small-text">Please select window first.</div>';
    return;
  }

  const sheetId = SHEET_IDS[windowoption];
  if (!sheetId) {
    dot.classList.remove("blink"); dot.textContent = "R"; text.textContent = "Invalid window";
    return;
  }

  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=TheMaster`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const textData = await response.text();

    // Parse gviz JSON safely
    let jsonData;
    try {
      const jsonText = textData.replace(/.*google.visualization.Query.setResponse\(/s, '').slice(0, -2);
      jsonData = JSON.parse(jsonText);
    } catch (e) {
      throw new Error("Failed to parse sheet data");
    }

    const rows = jsonData.table?.rows || [];
    const users = [];
    const userPart = email.toLowerCase().split('@')[0];

    for (const row of rows) {
      const cols = row.c || [];
      // Safe access to column N (index 13), P(15), Q(16), S(18)
      const usernameCell = cols[13];
      const username = (typeof usernameCell?.v === 'string') ? usernameCell.v.trim() : "";
      
      if (username && username.toLowerCase().includes(userPart)) {
        const contact = (typeof cols[15]?.v === 'string') ? cols[15].v : "";
        const area = (typeof cols[16]?.v === 'string') ? cols[16].v : "";
        const power = (typeof cols[18]?.v === 'string') ? cols[18].v : "";
        users.push({ username, contact, area, power });
      }
    }

    dot.classList.remove("blink");
    if (users.length === 0) {
      dot.textContent = "Y"; text.textContent = "No users found";
      document.getElementById('userListContainer').innerHTML = '<div style="margin-top:12px;color:#b91c1c;font-weight:bold;">VBO could not find any user on this line!</div>';
    } else {
      dot.textContent = "G"; text.textContent = "User list loaded";
      renderUserTable(users);
    }
  } catch (err) {
    dot.classList.remove("blink"); dot.textContent = "P"; text.textContent = "Network error";
    document.getElementById('userListContainer').innerHTML = `<div class="muted small-text">Error: ${escapeHtml(err.message)}</div>`;
  }
}

function renderUserTable(users) {
  let html = `<table><thead><tr><th>SN</th><th>User name</th><th>Contact</th><th>Area</th><th>Power</th></tr></thead><tbody>`;
  users.forEach((u, idx) => {
    html += `<tr><td>${idx + 1}</td><td>${escapeHtml(u.username)}</td><td>${escapeHtml(u.contact)}</td><td>${escapeHtml(u.area)}</td><td>${escapeHtml(u.power)}</td></tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('userListContainer').innerHTML = html;
}

/* ========== UI helpers ========== */
function showToast(text, type="default") {
  const toast = document.createElement("div"); toast.className = `toast ${type}`; toast.textContent = text;
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),600); },3000);
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ========== Local form save/load ========== */
function saveFormData() {
  const data = {};
  fieldsToSave.forEach(field => { const el = document.querySelector(`[name="${field}"]`); if (el) data[field] = el.value; });
  localStorage.setItem('formData', JSON.stringify(data));
}
async function loadFormData() {
  const data = JSON.parse(localStorage.getItem('formData')||"{}");
  fieldsToSave.forEach(field => { const el = document.querySelector(`[name="${field}"]`); if (el && data[field]) el.value = data[field]; });
  await loadPhoto('photo1'); await loadPhoto('photo2');

  ['1','2','3'].forEach(n => {
    const iso = localStorage.getItem(`ts${n}`);
    if (iso) {
      const d = new Date(iso);
      const disp = d.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }).replace(',', '');
      document.getElementById(`ts${n}disp`).textContent = disp;
    }
  });

  const has1 = !!localStorage.getItem('ts1');
  const has2 = !!localStorage.getItem('ts2');
  const has3 = !!localStorage.getItem('ts3');

  if (has1 && has2 && has3) {
    ['1','2','3'].forEach(n=>{ const b=document.getElementById(`tsBtn${n}`); b.classList.add('disabled'); b.disabled=true; });
    document.getElementById('submitBtn').disabled = false;
  } else {
    resetTimestampButtons();
    if (has1) {
      document.getElementById('tsBtn1').classList.add('disabled'); document.getElementById('tsBtn1').disabled = true;
      document.getElementById('tsBtn2').classList.remove('disabled'); document.getElementById('tsBtn2').disabled = false;
    }
    if (has2) {
      document.getElementById('tsBtn2').classList.add('disabled'); document.getElementById('tsBtn2').disabled = true;
      document.getElementById('tsBtn3').classList.remove('disabled'); document.getElementById('tsBtn3').disabled = false;
    }
    if (has3) document.getElementById('tsBtn3').classList.add('disabled'), document.getElementById('tsBtn3').disabled = true;
  }
}
async function loadPhoto(name) {
  const base64 = localStorage.getItem(name);
  if (!base64) return;
  try {
    const response = await fetch(base64); const blob = await response.blob();
    const file = new File([blob], `${name}.jpg`, {type:'image/jpeg'});
    const input = document.querySelector(`[name="${name}"]`);
    const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; input.classList.add('selected');
  } catch(err){ console.error('Failed to load photo:',err); }
}
function savePhotoAndHighlight(e) {
  const input = e.target; const file = input.files[0];
  if (file) { compressImageToDataURL(file,200).then(dataUrl=>{ localStorage.setItem(input.name, dataUrl); input.classList.add('selected'); }).catch(err=>console.error(err)); }
  else input.classList.remove('selected');
}

/* ========== INITIALIZE FORM ========== */
function initializeForm() {
  document.getElementById("whoami").innerHTML = `Check users on this line`;
  loadFormData();
  fieldsToSave.forEach(field => { const el = document.querySelector(`[name="${field}"]`); if (el){ el.addEventListener('change', saveFormData); el.addEventListener('input', saveFormData); }});
  autoDetectLocation();

  document.getElementById('tsBtn1').addEventListener('click', () => captureTimestamp(1));
  document.getElementById('tsBtn2').addEventListener('click', () => captureTimestamp(2));
  document.getElementById('tsBtn3').addEventListener('click', () => captureTimestamp(3));

  resetTimestampButtons();
}

function autoDetectLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    let loc = document.querySelector("[name=locationLink]");
    if (!loc) { loc = document.createElement('input'); loc.type='hidden'; loc.name='locationLink'; document.getElementById('dataForm').appendChild(loc); }
    loc.value = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  }, ()=>{}, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
}

/* ========== USER LIST MODAL ========== */
function openUserListModal() {
  document.getElementById('userListContainer').innerHTML = '<div class="muted small-text">Fetching user list…</div>';
  document.getElementById('userListModal').style.display = 'flex';
  fetchUserList();
}
function closeUserListModal() { document.getElementById('userListModal').style.display = 'none'; }
</script>
</body>
</html>
