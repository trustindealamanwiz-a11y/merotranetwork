<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Check users on this line</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:16px; background:#f7fafc; color:#111827;}
    .page-title { font-size:20px; margin:0 0 12px 0; }
    .card { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); max-width:900px; margin-bottom:12px;}
    .row { margin:8px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#6b7280; }
    .hidden { display:none; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
    .btn.primary { background:#0ea5a4; color:#fff; }
    .btn.success { background:#10b981; color:#fff; }
    .btn.danger { background:#ef4444; color:#fff; }
    select,input[type="text"],input[type="number"],textarea { padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px; }
    textarea { min-height:80px; width:100%; }
    input[type="file"] { display:block; padding:8px; border-radius:8px; border:2px dashed #aaa; background:#f9f9f9; cursor:pointer; width:100%; }

    .small-text { font-size:12px; }
    .center { justify-content:center; }

    .toast { position:fixed; right:12px; bottom:12px; background:#111827; color:#fff; padding:8px 12px; border-radius:8px; z-index:2000; opacity:0.95; }
    .toast.success { background:#059669; } 
    .toast.error { background:#dc2626; } 
    .toast.info { background:#0ea5a4; }

    .spinner-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); z-index:9999; }
    .spinner { width:48px; height:48px; border-radius:50%; border:5px solid #f3f4f6; border-top-color:#3b82f6; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }

    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2000; align-items:center; justify-content:center; }
    .modal-box { background:#fff; padding:16px; border-radius:10px; max-width:980px; width:95%; max-height:85vh; overflow:auto; }

    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th,td { padding:8px; border:1px solid #e5e7eb; text-align:left; font-size:13px; }
    th { background:#f3f4f6; }

    @keyframes blink { 50% { opacity:0; } }
    .blink { animation: blink 1s infinite; }

    #statusDot { font-size:18px; margin-right:6px; }
    #userListStatus { display:flex; align-items:center; font-weight:700; gap:6px; }

    .timestamp-display { font-size:13px; color:#374151; min-width:260px; display:inline-block; }
    .selected { border-color:#45b08e; background:#e6ffed; }
  </style>
</head>

<body>

<header>
  <h2 class="page-title">Check users on this line</h2>
</header>

<!-- SIGN-IN PANEL -->
<div id="signinCard" class="card">
  <div class="row center"><div id="signinBtn"></div></div>
  <div id="accessMsg" class="row muted small-text">Please contact Admin if your ID is not registered!</div>
  <div id="deniedMsg" class="row" style="color:#b91c1c; display:none;">Access denied ‚Äî Contact admin!</div>
</div>

<!-- MAIN FORM -->
<div id="formCard" class="card hidden">
  <div class="row muted" id="whoami"></div>

  <form id="dataForm">
    <input type="email" name="email" class="hidden" readonly required />

    <div class="row">
      <select name="windowoption" required>
        <option value="">Select Window</option>
        <option>Merotra</option>
        <option>Sunny</option>
      </select>
    </div>

    <!-- TIMESTAMP BUTTONS -->
    <div class="row">
      <button type="button" class="btn primary" id="tsBtn1">‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ú‡•ã‡•ú‡§§‡•á ‡§π‡•Ä ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</button>
      <span id="ts1disp" class="timestamp-display"></span>
    </div>

    <div class="row">
      <button type="button" class="btn primary" id="tsBtn2" disabled>‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§¨‡§æ‡§∞ ‡§ú‡•ã‡•ú‡§§‡•á ‡§π‡•Ä ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</button>
      <span id="ts2disp" class="timestamp-display"></span>
    </div>

    <div class="row">
      <button type="button" class="btn primary" id="tsBtn3" disabled>‡§§‡•Ä‡§∏‡§∞‡•Ä ‡§¨‡§æ‡§∞ ‡§ú‡•ã‡•ú‡§§‡•á ‡§π‡•Ä ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</button>
      <span id="ts3disp" class="timestamp-display"></span>
    </div>

    <div class="row">
      <select name="splitter" required>
        <option value="">Select Splitter</option>
        <option>2 way</option>
        <option>4 way</option>
        <option>8 way</option>
        <option>Link JC</option>
      </select>
    </div>

    <!-- PHOTOS -->
    <div class="form-step">‡§°‡•ç‡§∞‡§Æ ‡§®‡§Ç‡§¨‡§∞ ‡§î‡§∞ ‡§ú‡•á ‡§∏‡•Ä ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã</div>
    <div class="row"><input type="file" name="photo1" accept="image/*" capture="environment" required></div>

    <div class="form-step">‡§™‡•ã‡§≤ ‡§î‡§∞ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã</div>
    <div class="row"><input type="file" name="photo2" accept="image/*" capture="environment" required></div>

    <div class="row">
      <input type="text" name="jcname" required placeholder="Enter JC Name" />
    </div>

    <div class="row">
      <select name="wire" required>
        <option value="">Select Wire</option>
        <option>1 Core</option><option>2 Core</option><option>4 Core</option>
        <option>6 Core</option><option>12 Core</option><option>96 Core</option>
      </select>
    </div>

    <div class="row">
      <input type="number" name="vacantcores" required placeholder="Enter Vacant Cores" />
    </div>

    <div class="row">
      <select name="wirecolor">
        <option value="">Select fiber color</option>
        <option>Black</option>
        <option>Orange</option>
        <option>Other</option>
      </select>
    </div>

    <div class="row">
      <input type="text" name="linename" placeholder="Line Name (Optional)" />
    </div>

    <div class="row">
      <input type="text" name="drumno" placeholder="Drum No (Optional)" />
    </div>

    <div class="row">
      <input type="text" name="remark" placeholder="Input power (‡§Æ‡§æ‡§™‡•á‡§Ç/‡§®‡•ã‡§ü‡•ç‡§∏)" />
    </div>

    <div class="row actions">
      <button type="button" id="submitBtn" class="btn success" disabled>
        Submit to check users on this line
      </button>
      <span id="submitStatus" class="muted small-text"></span>
    </div>
  </form>
</div>

<!-- POPUP -->
<div id="userListModal" class="modal-overlay">
  <div class="modal-box">
    <div id="userListStatus">
      <span id="statusDot">üü†</span>
      <span id="statusText">Fetching user list‚Ä¶</span>
    </div>
    <div id="userListContainer"><div class="muted small-text">Waiting‚Ä¶</div></div>
    <div class="modal-actions" style="margin-top:12px; text-align:right;">
      <button id="closeUserListBtn" class="btn">Close</button>
    </div>
  </div>
</div>
<script>

/* ===============================
   CONFIG
================================*/
const allowedEmails = [
  "shahzebahmad2024@gmail.com",
  "trustindeal.amanwiz@gmail.com",
  "alamshan761@gmail.com",
  "ganeshnigam597@gmail.com",
  "sushilyadav8352@gmail.com",
  "ainulkhan424@gmail.com",
  "sushilya9044@gmail.com",
  "sy7903125@gmail.com"
];

const scriptURL = "https://script.google.com/macros/s/AKfycbyBZtPsTNzsQo5OMNE6yqGmWb12030EzpmxzOXPzNlKrvEOIunkYL-8B6pjWfYtuq9R/exec";

const clientID = "599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com";

/* Disable submit for 8 minutes (changeable) */
const DISABLE_SECONDS = 1 * 60;

/* Timer updates every 3 seconds */
const TIMER_UPDATE_INTERVAL = 3000;

let timerInterval = null;
let timerDisplayInterval = null;
let timerRemaining = 0;

const fieldsToSave = [
  "windowoption","splitter","jcname","wire",
  "vacantcores","wirecolor","linename","drumno","remark"
];

/* ===============================================
   INIT
================================================*/
window.onload = () => {

  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({
      client_id: clientID,
      callback: handleCredentialResponse
    });

    google.accounts.id.renderButton(
      document.getElementById("signinBtn"),
      { theme: "outline", size: "large", type: "standard", shape:"pill" }
    );
  }

  document.getElementById("submitBtn").addEventListener("click", onSubmitClick);
  document.getElementById("closeUserListBtn").addEventListener("click", closeUserListModal);

  document.querySelector('[name="photo1"]').addEventListener("change", savePhotoAndHighlight);
  document.querySelector('[name="photo2"]').addEventListener("change", savePhotoAndHighlight);

  document.getElementById("tsBtn1").addEventListener("click", ()=>captureSequence(1));
  document.getElementById("tsBtn2").addEventListener("click", ()=>captureSequence(2));
  document.getElementById("tsBtn3").addEventListener("click", ()=>captureSequence(3));

  document.getElementById("dataForm").addEventListener("change", saveFormData);

  const saved = JSON.parse(localStorage.getItem("userSession")||null);
  if (saved && Date.now() - saved.timestamp < 3600000) {
    document.querySelector('[name="email"]').value = saved.email;
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
    initializeForm();
  }
};

/* ===============================================
   GOOGLE SIGN-IN
================================================*/
function parseJwt(token) {
  try {
    const base64Url = token.split(".")[1];
    const base64 = base64Url.replace(/-/g,"+").replace(/_/g,"/");
    const jsonPayload = decodeURIComponent(atob(base64).split("").map(c =>
      "%" + ("00"+c.charCodeAt(0).toString(16)).slice(-2)
    ).join(""));
    return JSON.parse(jsonPayload);
  } catch { return {}; }
}

function handleCredentialResponse(res) {
  const data = parseJwt(res.credential);
  const email = data.email || "";

  if (allowedEmails.includes(email)) {
    localStorage.setItem("userSession", JSON.stringify({ email, timestamp: Date.now() }));
    document.querySelector("[name=email]").value = email;
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
    initializeForm();
  } else {
    document.getElementById("deniedMsg").style.display = "block";
  }
}

/* ===============================================
   IMAGE COMPRESSION
================================================*/
function compressImageToDataURL(file, maxKB = 200) {
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onerror = ()=>reject(new Error("File read error"));
    reader.onload = () => {
      const img = new Image();
      img.onerror = ()=>reject(new Error("Invalid image"));
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const ratio = Math.min(1, Math.sqrt((maxKB*1024)/(file.size || (img.width*img.height))));
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        ctx.drawImage(img,0,0,canvas.width,canvas.height);

        let q = 0.75;
        let url = canvas.toDataURL("image/jpeg", q);
        while (url.length/1024 > maxKB && q > 0.2) {
          q -= 0.05;
          url = canvas.toDataURL("image/jpeg", q);
        }
        resolve(url);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ===============================================
   TIMESTAMP (IST + Sequential)
================================================*/

let allow2 = false;
let allow3 = false;

function captureSequence(which) {
  if (which === 1) {
    captureTimestamp(1);
    allow2 = true;
    document.getElementById("tsBtn1").disabled = true;
    setTimeout(() => {
      document.getElementById("tsBtn2").disabled = false;
    }, 20000);
    return;
  }

  if (which === 2) {
    if (!allow2) return showToast("‡§™‡§π‡§≤‡•á ‡§™‡§π‡§≤‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å!", "error");
    captureTimestamp(2);
    allow3 = true;
    document.getElementById("tsBtn2").disabled = true;
    setTimeout(() => {
      document.getElementById("tsBtn3").disabled = false;
    }, 20000);
    return;
  }

  if (which === 3) {
    if (!allow3) return showToast("‡§™‡§π‡§≤‡•á ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å!", "error");
    captureTimestamp(3);
    document.getElementById("tsBtn3").disabled = true;
    showToast("‡§§‡•Ä‡§®‡•ã‡§Ç ‡§ü‡§æ‡§á‡§Æ‡§∏‡•ç‡§ü‡•à‡§Æ‡•ç‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§π‡•Å‡§è!", "success");
    document.getElementById("submitBtn").disabled = false;
  }
}

function captureTimestamp(which) {
  let now = new Date();

  // Convert to IST
  let ist = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  let iso = ist.toISOString();

  localStorage.setItem("ts"+which, iso);

  let readable = iso.replace("T"," ").replace(".000Z","").slice(0,19);

  document.getElementById("ts"+which+"disp").textContent = readable;
  showToast(`Timestamp ${which} captured (IST)`, "info");
}

/* ===============================================
   SUBMIT DATA ‚Üí GAS
================================================*/
async function onSubmitClick() {
  const btn = document.getElementById("submitBtn");

  // If button mode is 'show user list'
  if (btn.dataset.mode === "show") {
    openUserListModal();
    return;
  }

  const t1 = localStorage.getItem("ts1"),
        t2 = localStorage.getItem("ts2"),
        t3 = localStorage.getItem("ts3");

  if (!t1 || !t2 || !t3) {
    showToast("‡§§‡•Ä‡§®‡•ã‡§Ç ‡§ü‡§æ‡§á‡§Æ‡§∏‡•ç‡§ü‡•à‡§Æ‡•ç‡§™ ‡§™‡§π‡§≤‡•á ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç!", "error");
    return;
  }

  const form = document.getElementById("dataForm");
  const p1 = form.photo1.files[0];
  const p2 = form.photo2.files[0];

  if (!p1 || !p2) {
    showToast("JC Photo ‡§î‡§∞ Area Photo ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡§Ç‡•§", "error");
    return;
  }

  // spinner
  const overlay = document.createElement("div");
  overlay.className = "spinner-overlay";
  overlay.innerHTML = '<div class="spinner"></div>';
  document.body.appendChild(overlay);

  let photos;
  try {
    photos = [
      await compressImageToDataURL(p1, 200),
      await compressImageToDataURL(p2, 200)
    ];
  } catch (err) {
    overlay.remove();
    showToast("Image processing error", "error");
    return;
  }

  const payload = {
    action: "submit",
    email: form.email.value,
    photos,
    jcname: form.jcname.value,
    splitter: form.splitter.value,
    wire: form.wire.value,
    wirecolor: form.wirecolor.value,
    linename: form.linename.value,
    drumno: form.drumno.value,
    remark: form.remark.value,
    vacantcores: form.vacantcores.value,
    windowoption: form.windowoption.value,
    ts1: t1, ts2: t2, ts3: t3
  };

  try {
    const res = await fetch(scriptURL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();

    overlay.remove();

    if (json.status === "success") {
      showToast("‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ! ‡§Ö‡§¨ users check ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§", "success");

      // disable submit for 8 min
      startDisableTimer(DISABLE_SECONDS);

      // clear timestamps
      localStorage.removeItem("ts1");
      localStorage.removeItem("ts2");
      localStorage.removeItem("ts3");

      document.getElementById("ts1disp").textContent = "";
      document.getElementById("ts2disp").textContent = "";
      document.getElementById("ts3disp").textContent = "";
    }
  } catch(err) {
    overlay.remove();
    showToast("Network error", "error");
  }
}

/* ===============================================
   SUBMIT ‚Üí DISABLE TIMER
================================================*/
function startDisableTimer(sec) {
  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.dataset.mode = "submit";

  timerRemaining = sec;

  clearInterval(timerInterval);
  clearInterval(timerDisplayInterval);

  timerInterval = setInterval(()=>{
    timerRemaining--;
    if (timerRemaining <= 0) {
      clearInterval(timerInterval);
      btn.disabled = false;
      btn.dataset.mode = "show";
      btn.textContent = "Show user list";
      showToast("‡§Ö‡§¨ ‡§Ü‡§™ user list ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç", "success");
    }
  },1000);

  timerDisplayInterval = setInterval(() => {
    const mm = Math.floor(timerRemaining/60);
    const ss = timerRemaining % 60;
    btn.textContent = `Submit to check users on this line (${mm}m ${ss}s)`;
  }, TIMER_UPDATE_INTERVAL);
}
/* ===============================================
   USER LIST POPUP
================================================*/
function openUserListModal() {
  document.getElementById("userListContainer").innerHTML =
    '<div class="muted small-text">Fetching user list‚Ä¶</div>';

  document.getElementById("userListModal").style.display = "flex";

  fetchUserList();
}

function closeUserListModal() {
  document.getElementById("userListModal").style.display = "none";
}

/* ===============================================
   FETCH USER LIST FROM GAS
================================================*/
async function fetchUserList() {

  const dot = document.getElementById("statusDot");
  const txt = document.getElementById("statusText");

  dot.textContent = "üü†";
  dot.classList.add("blink");
  txt.textContent = "Fetching user list‚Ä¶";

  const email = document.querySelector("[name=email]").value;
  const windowoption = document.querySelector("[name=windowoption]").value;

  if (!windowoption) {
    dot.classList.remove("blink");
    dot.textContent = "‚≠ï";
    txt.textContent = "Select window";
    document.getElementById("userListContainer").innerHTML =
      "<div class='muted small-text'>Please select window first.</div>";
    return;
  }

  const payload = {
    action: "get_users",
    email,
    windowoption
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    dot.classList.remove("blink");

    /* üî¥ No users */
    if (json.status === "success" && Array.isArray(json.users) && json.users.length === 0) {
      dot.textContent = "‚≠ï";
      txt.textContent = "No users found";

      document.getElementById("userListContainer").innerHTML =
        "<div style='margin-top:12px;color:#b91c1c;font-weight:bold;'>VBO could not find any user on this line !</div>";

      return;
    }

    /* üü¢ Success */
    if (json.status === "success" && Array.isArray(json.users)) {
      dot.textContent = "üü¢";
      txt.textContent = "User list loaded";
      renderUserTable(json.users);
      return;
    }

    /* üü° Some server-side message */
    dot.textContent = "üü°";
    txt.textContent = "Server message";
    document.getElementById("userListContainer").innerHTML =
      `<div class="muted small-text">${json.message || "Unknown error"}</div>`;

  } catch (err) {
    dot.classList.remove("blink");
    dot.textContent = "üü£";
    txt.textContent = "Network error";

    document.getElementById("userListContainer").innerHTML =
      `<div class="muted small-text">Network error: ${err}</div>`;
  }
}

/* ===============================================
   RENDER USER TABLE
================================================*/
function renderUserTable(users) {
  if (!users.length) {
    document.getElementById("userListContainer").innerHTML =
      "<div class='muted small-text'>No common users found.</div>";
    return;
  }

  let html =
    `<table>
      <thead>
        <tr>
          <th>SN</th>
          <th>User name</th>
          <th>Contact</th>
          <th>Area</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>`;

  users.forEach((u, i) => {
    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(u.username || "")}</td>
        <td>${escapeHtml(u.contact || "")}</td>
        <td>${escapeHtml(u.area || "")}</td>
        <td>${escapeHtml(u.time || "")}</td>
      </tr>`;
  });

  html += "</tbody></table>";

  document.getElementById("userListContainer").innerHTML = html;
}

/* Escape HTML */
function escapeHtml(s) {
  if (!s) return "";
  return s.replace(/[&<>"']/g, m =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
  );
}

/* ===============================================
   SAVE LOCAL FORM & PHOTOS
================================================*/
function saveFormData() {
  const data = {};
  fieldsToSave.forEach(f => {
    const el = document.querySelector(`[name="${f}"]`);
    if (el) data[f] = el.value;
  });
  localStorage.setItem("formData", JSON.stringify(data));
}

async function loadFormData() {
  const data = JSON.parse(localStorage.getItem("formData") || "{}");

  fieldsToSave.forEach(f => {
    const el = document.querySelector(`[name="${f}"]`);
    if (el && data[f]) el.value = data[f];
  });

  await loadPhoto("photo1");
  await loadPhoto("photo2");

  ["ts1", "ts2", "ts3"].forEach(id => {
    const val = localStorage.getItem(id);
    if (val)
      document.getElementById(id + "disp").textContent =
        val.replace("T", " ").replace(".000Z", "").slice(0, 19);
  });
}

/* Load saved photo */
async function loadPhoto(name) {
  const base64 = localStorage.getItem(name);
  if (!base64) return;

  try {
    const response = await fetch(base64);
    const blob = await response.blob();
    const file = new File([blob], `${name}.jpg`, { type: "image/jpeg" });
    const input = document.querySelector(`[name="${name}"]`);
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    input.classList.add("selected");
  } catch (err) {
    console.error("Failed loading saved photo", err);
  }
}

/* Highlight photo input + save */
function savePhotoAndHighlight(e) {
  const input = e.target;
  const f = input.files[0];
  if (f) {
    compressImageToDataURL(f, 200).then(url => {
      localStorage.setItem(input.name, url);
      input.classList.add("selected");
    });
  }
}

/* ===============================================
   INITIALIZE FORM
================================================*/
function initializeForm() {
  document.getElementById("whoami").textContent = "Check users on this line";
  loadFormData();
  autoDetectLocation();

  // Start with only button 1 enabled
  document.getElementById("tsBtn1").disabled = false;
  document.getElementById("tsBtn2").disabled = true;
  document.getElementById("tsBtn3").disabled = true;
}

/* Auto-detect GPS */
function autoDetectLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    pos => {
      let lat = pos.coords.latitude,
        lng = pos.coords.longitude;
      let input = document.querySelector("[name=locationLink]");
      if (!input) {
        input = document.createElement("input");
        input.type = "hidden";
        input.name = "locationLink";
        document.getElementById("dataForm").appendChild(input);
      }
      input.value = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    },
    () => {},
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

/* ===============================================
   TOAST
================================================*/
function showToast(msg, type = "info") {
  const t = document.createElement("div");
  t.className = "toast " + type;
  t.textContent = msg;
  document.body.appendChild(t);

  setTimeout(() => {
    t.style.opacity = "0";
    setTimeout(() => t.remove(), 600);
  }, 2800);
}

</script>

</body>
</html>
