<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tag Splitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="style.css">
<style>/* File input custom style with camera icon */
input[type="file"] {
  display: block;
  padding: 8px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: #f9f9f9 url('https://cdn-icons-png.flaticon.com/512/685/685655.png') no-repeat 10px center;
  background-size: 20px 20px;
  padding-left: 40px;
  cursor: pointer;
  transition: 0.3s ease;
}

input[type="file"]:hover {
  border-color: #007bff;
  background-color: #eef6ff;
}

input[type="file"]::-webkit-file-upload-button {
  visibility: hidden;
}

input[type="file"]::before {
  content: "📷 Choose Photo";
  display: inline-block;
  background: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 5px;
  font-size: 14px;
  margin-right: 10px;
  cursor: pointer;
}

input[type="file"]:hover::before {
  background: #0056b3;
}
</style>
  
</head>
<body>
  <header>
    <h2 class="page-title">Tag Splitter</h2>
  </header>

  <!-- Sign-in card -->
  <div id="signinCard" class="card">
    <div class="row center">
      <div id="signinBtn"></div>
    </div>
    <div id="accessMsg" class="row muted small-text">
      Please contact Admin if your ID is not registered!
    </div>
    <div id="deniedMsg" class="row error hidden">
      Access denied — Contact admin for allowing your mail ID!
    </div>
  </div>

  <!-- Form card -->
  <div id="formCard" class="card hidden">
    <div class="row muted" id="whoami"></div>
    
    <form id="dataForm" class="form">
      <input type="email" name="email" class="hidden" readonly required />
      <input type="hidden" name="startTime" />
<div class="row">
  <select name="windowoption" required>
    <option value="">Select Window</option>
    <option>Merotra</option>
    <option>Sunny</option>
    
  </select>
</div>
      <div class="form-step">Step 1 - Click on start Tagging</div>
      <div id="locationRow" class="row hidden">
        <input type="text" name="locationLink" placeholder="Enter Google Maps Link" />
      </div>
      <button type="button" id="startTaggingBtn" class="btn primary" onclick="startTagging()">Start Tagging</button>

      <div class="form-step">Step 2 - Break splitter input</div>
      <div class="row">
        <select name="splitter" required>
          <option value="">Select Splitter</option>
          <option>2 way</option>
          <option>4 way</option>
          <option>8 way</option>
          <option>16 way</option>
        </select>
      </div>

      <div class="form-step">Step 3 - Attach JC pick</div>
      <div class="row">
        <input type="file" name="photo1" accept="image/*" capture="environment" required />
      </div>

      <div class="form-step">Step 4 - Attach location pick</div>
      <div class="row">
        <input type="file" name="photo2" accept="image/*" capture="environment" required />
      </div>

      <div class="form-step">Step 5 - Fill line details</div>
      <div class="row">
        <input type="text" name="jcname" required placeholder="Enter JC Name" />
      </div>
<div class="row">
  <select name="wire" required>
    <option value="">Select Wire</option>
    <option>1 Core</option>
    <option>2 Core</option>
    <option>4 Core</option>
    <option>6 Core</option>
    <option>12 Core</option>
    <option>96 Core</option>
  </select>
</div>

<div class="row">
  <input type="number" name="vacantcores" required placeholder="Enter Vacant Cores" />
</div>

      <div class="row">
        <select name="wirecolor">
          <option value="">Select Wire Color</option>
          <option>Black</option>
          <option>Orange</option>
          <option>Other</option>
        </select>
      </div> 
      <div class="row">
        <input type="text" name="linename" placeholder="Line Name (Optional)" />
      </div>
      <div class="row">
        <input type="text" name="drumno" placeholder="Drum No (Optional)" />
      </div>
      <div class="row">
        <textarea name="remark" placeholder="Write remarks..."></textarea>
      </div>

      <div class="form-step">Step 6 - Splice Splitter input</div>
      <div class="row actions">
        <button type="submit" id="submitBtn" class="btn success" disabled>
          Tagging done <span id="countdown"></span>
        </button>
        <br>
        <span id="submitStatus" class="muted small-text"></span>
      </div>
    </form>
  </div>

  <script>
const allowedEmails = ["shahzebahmad2024@gmail.com", "trustindeal.amanwiz@gmail.com", "mrityunjaykumar9151@gmail.com", "ganeshnigam597@gmail.com"];
const scriptURL = "https://script.google.com/macros/s/AKfycbxRnBmBu_ozeU05Wv7cesr5AsWCIILv8FEwaeUnGyDyswJ86hyQWPX259_vwAJZ-h_S/exec";
const clientID = "599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com";

const FORM_STORAGE_KEY = "tagSplitterForm";
const START_TIME_KEY = "tagSplitterStartTime";

window.onload = () => {
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({
      client_id: clientID,
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("signinBtn"),
      { theme: "outline", size: "large", type: "standard", shape: "pill" }
    );
  }
  document.getElementById("dataForm").addEventListener("submit", onSubmit);
  autoDetectLocation();
  restoreForm();
  if (localStorage.getItem(START_TIME_KEY)) runCountdown();
};

function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  } catch {
    return {};
  }
}

function handleCredentialResponse(response) {
  const payload = parseJwt(response.credential);
  const email = payload.email || "";

  if (allowedEmails.includes(email)) {
    localStorage.setItem("userSession", JSON.stringify({
      email: email,
      timestamp: Date.now()
    }));

    document.querySelector('[name="email"]').value = email;
    document.getElementById("whoami").innerHTML = `Fiber line marking`;
    document.getElementById("deniedMsg").classList.add("hidden");
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
  } else {
    document.getElementById("deniedMsg").classList.remove("hidden");
  }
}

function autoDetectLocation() {
  if (!navigator.geolocation) {
    document.getElementById("locationRow").classList.remove("hidden");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      document.querySelector("[name=locationLink]").value =
        `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    },
    () => document.getElementById("locationRow").classList.remove("hidden"),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function compressImageToDataURL(file, maxKB = 200) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Failed to read file"));
    reader.onload = () => {
      const img = new Image();
      img.onerror = () => reject(new Error("Invalid image"));
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const scale = Math.min(1, Math.sqrt((maxKB * 1024) / (file.size || (img.width * img.height))));
        canvas.width = Math.max(1, Math.round(img.width * scale));
        canvas.height = Math.max(1, Math.round(img.height * scale));
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        let quality = 0.75;
        let dataUrl = canvas.toDataURL("image/jpeg", quality);
        while (dataUrl.length / 1024 > maxKB && quality > 0.2) {
          quality -= 0.05;
          dataUrl = canvas.toDataURL("image/jpeg", quality);
        }
        resolve(dataUrl);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

async function onSubmit(e) {
  e.preventDefault();
  const form = e.target;

  const overlay = document.createElement("div");
  overlay.className = "spinner-overlay";
  overlay.innerHTML = '<div class="spinner"></div><div class="spinner-text">Submitting...</div>';
  document.body.appendChild(overlay);

  const p1 = form.photo1.files[0];
  const p2 = form.photo2.files[0];
  if (!p1 || !p2) {
    document.querySelector(".spinner-overlay")?.remove();
    showToast("❌ Both JC Photo and Area Photo are required", "error");
    return;
  }

  let photos;
  try {
    photos = [await compressImageToDataURL(p1, 200), await compressImageToDataURL(p2, 200)];
  } catch (err) {
    document.querySelector(".spinner-overlay")?.remove();
    showToast("❌ Image processing failed: " + err.message, "error");
    return;
  }

  const payload = {
    email: form.email.value,
    locationLink: form.locationLink.value,
    photos,
    jcname: form.jcname.value,
    splitter: form.splitter.value,
    wire: form.wire.value,
    wirecolor: form.wirecolor.value,
    linename: form.linename.value,
    drumno: form.drumno.value,
    remark: form.remark.value,
    vacantcores: form.vacantcores.value,
    windowoption: form.windowoption.value,
    startTime: form.startTime.value
  };

  fetch(scriptURL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(resp => {
    document.querySelector(".spinner-overlay")?.remove();
    if (resp.status === "success") {
      showToast("✅ Tagging submitted successfully!", "success");
      localStorage.removeItem(FORM_STORAGE_KEY);
      localStorage.removeItem(START_TIME_KEY);
      setTimeout(() => window.location.reload(), 2000);
    } else {
      showToast("❌ " + (resp.message || "Server error"), "error");
    }
  })
  .catch(err => {
    document.querySelector(".spinner-overlay")?.remove();
    showToast("❌ Network error: " + err, "error");
  });
}

function showToast(text, type) {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = text;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.classList.add("fade-out");
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

// ================= Form Auto-Save / Resume =================
function saveForm() {
  const form = document.getElementById("dataForm");
  const data = {};
  new FormData(form).forEach((v, k) => { data[k] = v; });
  localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
}

function restoreForm() {
  const saved = localStorage.getItem(FORM_STORAGE_KEY);
  if (!saved) return;
  const data = JSON.parse(saved);
  const form = document.getElementById("dataForm");
  Object.keys(data).forEach(k => {
    if (form[k]) form[k].value = data[k];
  });
}

document.getElementById("dataForm").addEventListener("input", saveForm);

// ================= Absolute Countdown Logic =================
function startTagging() {
  const startTimeField = document.querySelector('[name="startTime"]');
  const startBtn = document.getElementById('startTaggingBtn');

  const now = Date.now();
  localStorage.setItem(START_TIME_KEY, now);
  startTimeField.value = new Date(now).toISOString();

  startBtn.disabled = true;
  runCountdown();
  showToast("🕒 Please wait 600 seconds before submitting.", "info");
}

function runCountdown() {
  const submitBtn = document.getElementById('submitBtn');
  const countdownEl = document.getElementById('countdown');
  const startBtn = document.getElementById('startTaggingBtn');

  const startTime = parseInt(localStorage.getItem(START_TIME_KEY), 10);
  if (!startTime) return;

  startBtn.disabled = true;

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    let remaining = 600 - elapsed;

    if (remaining <= 0) {
      submitBtn.disabled = false;
      countdownEl.textContent = "";
      localStorage.removeItem(START_TIME_KEY);
      return;
    }

    submitBtn.disabled = true;
    countdownEl.textContent = `(${remaining}s)`;
    requestAnimationFrame(updateTimer);
  }

  updateTimer();
}
</script>


  
</body>
</html>
